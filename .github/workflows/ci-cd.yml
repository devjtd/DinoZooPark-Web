# .github/workflows/ci-cd.yml

name: CI/CD Pipeline
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
 
permissions:
  contents: read
  pages: write # Necesario para desplegar en GitHub Pages
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  ci:
    name: Pruebas y validación
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar HTMLHint
        run: npm install -g htmlhint

      # Validación de HTML solo en la carpeta de plantillas
      - name: Validar HTML
        run: |
          echo " Ejecutando HTMLHint..."
          # Apuntamos a todos los archivos .html dentro de src/main/resources/templates
          htmlhint src/main/resources/templates/**/*.html --rules "tag-pair,attr-value-double-quotes,id-unique,doctype-first"
          echo " HTML válido"
 
      # Lighthouse CI apuntando a la carpeta de plantillas
      - name: Instalar y ejecutar Lighthouse CI (accesibilidad + mejoras)
        run: |
          npm install -g @lhci/cli@0.15.x
          echo "Auditar con Lighthouse CI (modo 'perf', 'accessibility', 'best-practices')..."
          # staticDistDir apunta a la carpeta base de plantillas para su auditoría
          lhci autorun --upload.target=temporary-public-storage --collect.staticDistDir=src/main/resources/templates --collect.url=/index.html --assert.assertions.accessibility=warn --assert.assertions.performance=warn --assert.assertions['best-practices']=warn
 
  cd:
    name: Despliegue a GitHub Pages
    needs: ci
    if: github.ref == 'refs/heads/main' # Solo en push/merge a main
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
 
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      # --- NUEVO PASO CLAVE: Preparar la estructura plana para el despliegue ---
      # Esto crea la estructura esperada por GitHub Pages: index.html en la raíz
      - name: Preparar carpeta de despliegue (_site)
        run: |
          # Crea la carpeta de destino que será la raíz de GitHub Pages
          mkdir _site
          
          # 1. Copia todos los archivos HTML (incluyendo index.html) a la raíz de _site/
          # Esto asegura que index.html esté en el root del servidor (soluciona el 404).
          cp src/main/resources/templates/*.html _site/
          
          # 2. Copia la carpeta 'static' completa (CSS, JS, Img) a la raíz de _site/
          # Esto mantiene la ruta /static/ para todos tus recursos.
          cp -r src/main/resources/static _site/

      # --- AJUSTE CLAVE: Desplegar la carpeta _site/ ---
      - name: Upload artifact (Raíz plana)
        uses: actions/upload-pages-artifact@v3
        with:
          # Sube el contenido de la carpeta '_site' como la raíz del sitio web
          path: '_site'
 
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
